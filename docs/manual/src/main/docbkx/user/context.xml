<?xml version="1.0" encoding="UTF-8"?>
<!--

    Copyright 2010 OpenEngSB Division, Vienna University of Technology

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->

<chapter xml:id="developer.context" version="5.0" xmlns="http://docbook.org/ns/docbook"
  xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://docbook.org/ns/docbook http://www.docbook.org/xml/5.0/xsd/docbook.xsd
  http://www.w3.org/1999/xlink http://www.docbook.org/xml/5.0/xsd/xlink.xsd
  http://www.w3.org/2001/XMLSchema-instance http://www.w3.org/2001/XMLSchema-instance.xsd">

  <title>Context Management</title>

  <para>The context is one of the most important core concepts of the openengsb. It allows to reuse predefined
    workflows in several contexts. A context may often represent a project or subproject. So it is possible to execute
    the same workflow with the project-specific tool-instances and other metadata (like contact-information).

  <para>To determine in which context an action should be executed a thread-local variable is used. The
    <link xlink:href="${github}/core/common/src/main/java/org/openengsb/core/common/context/ContextHolder.java">
      ContextHolder
    </link>
    keeps track of this variable (the current threads' context). Invoking the set- and get-method will always
    manipulate the context of the current Thread. When a new Thread is spawned it inherits the context from the
    parent thread.
  </para>

  <para>
   This way connector-implementations and other client projects always can handle actions according to the current
   context, and execute actions in specific a specific context. So when a person with a certain role in the project
   (e.g. project manager) needs to be notified of some event, the value of his contact-address is specific to the
   context of the project(s) he is managing.
  </para>

  <section xml:id="developer.context.wiring">
    <title>Wiring services</title>

    <para>The context is also used to handle the wiring of services in workflows. Suppose there are two projects that
      use their own SCM-repositories and for both repositories connector-instances were created to poll them. When
      executing a workflow contains an action that polls the SCM, the correct service ca be picked by looking up the
      current thread's context.</para>

    <para>In general workflows have references to several domains and other services which they interact with during
      execution. Each project might have their own tools behind these domains, so these references must be resolved
      at runtime depending on the current context.

    <para>For this to work the workflow-engine declares global variables that are used in rules and processes. A variable is resolved by
      looking up the service with the same name in the current context. If no service with that name is available in
      the context it is looked up in the "root"-context.</para>

    <para>In detail the wiring is handled via the service-properties. Services contain properties where the key is of
      the format "location.&lt;contextid&gt;". The value is a list of "locations" where each location is delimited by
      square brackets ("[" and "]"). So a service may have several locations in several contexts.</para>

    <para>When a global variable is accessed during the execution of an action (from a process or rule), the
      osgi-context is queried for the correspinding service. The service wired to this variable must have location
      with the same name as the variable. The service is searched in the current context and the root-context. If no
      service is found, the action is stalled for 30 seconds. If there is still no service found an Exception is thrown.
      Internally this is handled using proxies. When the workflow service is started, all globals are populated with
      proxies, that automatically resolve the service with the corresponding location when a method is invoked.</para>

    <para>Example: The auditing-service is registered with the interface AuditingDomain. The service has property
      "location.root" with value "[auditing]". The workflow engine contains a global named "auditing" and a rule that
      invokes a method on every Event that is processed. When the rule fires and the consequence is executed, the proxy
      representing "auditing"-global queries for a service with the location.currentContext or the location.root
      containing "[auditing]". Since root-services get a service-ranking of "-1" by default, the service current
      context's would supersede the service located in the root-context.</para>
  </section>

  <section xml:id="developer.context.store">
    <title>Contextstore</title>
    <para>Each context also has an associated context-store to store meta information necessary for running inside of the
      OpenEngSB. The context store is represented as a tree structure with key-value pairs as leafs.</para>

    <para>The context in which a workflow is executed, a rule fired or another action happens can be compared to the
    project in which the respective action happens. The context store therefore offers the possibility to perform
    project specific configurations.</para>

    <para>The <link xlink:href="${github}/core/common/src/main/java/org/openengsb/core/common/context/ContextService.java">context service</link>
    can be used to query the context and to insert, update or delete values. Note that under a specific name either a node or a leaf can be found, but not both. That means that
    the context can be compared to a file system, where context nodes are directories and context leaves files. The leaves in the context contain string key-value pairs.
    </para>

    <para>The <link xlink:href="${github}/core/common/src/main/java/org/openengsb/core/common/context/ContextCurrentService.java">current context service</link>
      extends the context service and provides additional methods for the management new root context entries (which correspond to projects).
    </para>
  </section>

</chapter>

